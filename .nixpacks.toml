[phases.setup]
nixPkgs = ['nginx', 'php82', 'php82Extensions.mysqli']

[phases.install]
cmds = [
  "mkdir -p /var/log/nginx",
  "mkdir -p /var/cache/nginx",
  "mkdir -p /run"
]

[start]
cmd = """
# Start PHP-FPM
echo '
[global]
error_log = /dev/stderr
daemonize = no

[www]
listen = 127.0.0.1:9000
pm = dynamic
pm.max_children = 5
pm.start_servers = 2
pm.min_spare_servers = 1
pm.max_spare_servers = 3
' > /run/php-fpm.conf && \
PHP_INI_DIR=/run php-fpm -y /run/php-fpm.conf & \
sed -i "s|listen 0.0.0.0:8080|listen 0.0.0.0:$PORT|g" /app/nginx.conf && \
nginx -c /app/nginx.conf -g 'daemon off;'
"""